{% extends "base.html" %}

{% block title %}Restaurant Roulette - Find Your Perfect Dining Experience{% endblock %}

{% block content %}
<div class="text-center mb-5">
    <h1 class="display-4 fw-bold text-primary mb-3">
        <i class="fas fa-dice me-3"></i>Restaurant Roulette
    </h1>
    <p class="lead text-muted">Spin the wheel and discover restaurants that match your dining mood!</p>
</div>

<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="search-form">
            <form id="rouletteSearchForm">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="location" class="form-label fw-bold">
                            <i class="fas fa-map-marker-alt me-2"></i>Location
                        </label>
                        <input type="text" class="form-control form-control-lg" id="location" 
                               placeholder="e.g., New York City, San Francisco, Somerset, NJ" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="mood" class="form-label fw-bold">
                            <i class="fas fa-heart me-2"></i>Mood
                        </label>
                        <input type="text" class="form-control form-control-lg" id="mood" 
                               placeholder="e.g., spicy and exciting, romantic and cozy" required>
                    </div>
                </div>
                
                <div class="text-center">
                    <button type="submit" class="btn btn-success btn-search btn-lg">
                        <i class="fas fa-dice me-2"></i>Spin the Roulette!
                    </button>
                </div>
            </form>
        </div>
        
        <!-- Loading indicator -->
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <h4>Finding perfect restaurants for your roulette...</h4>
            <p class="text-muted">This may take a moment as we search for the best matches</p>
        </div>
        
        <!-- Error message -->
        <div class="error-message" id="errorMessage" style="display: none;">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <span id="errorText"></span>
        </div>
        
        <!-- Roulette will be displayed here -->
        <div id="rouletteContainer" style="display: none;">
            <!-- Roulette content will be dynamically inserted here -->
        </div>
    </div>
</div>

<div class="row mt-5">
    <div class="col-12">
        <div class="text-center">
            <h3 class="mb-4">How Restaurant Roulette Works</h3>
            <div class="row">
                <div class="col-md-4 mb-3">
                    <div class="card h-100">
                        <div class="card-body text-center">
                            <i class="fas fa-search fa-2x text-primary mb-3"></i>
                            <h5>1. Search</h5>
                            <p class="text-muted small">Enter your location and dining mood</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="card h-100">
                        <div class="card-body text-center">
                            <i class="fas fa-dice fa-2x text-success mb-3"></i>
                            <h5>2. Spin</h5>
                            <p class="text-muted small">Watch the roulette spin to find a random restaurant review</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="card h-100">
                        <div class="card-body text-center">
                            <i class="fas fa-utensils fa-2x text-warning mb-3"></i>
                            <h5>3. Discover</h5>
                            <p class="text-muted small">View the full restaurant details and all reviews</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="text-center mt-4">
    <a href="/" class="btn btn-outline-primary">
        <i class="fas fa-list me-2"></i>View Regular Results
    </a>
</div>
{% endblock %}

{% block scripts %}
<script>
document.getElementById('rouletteSearchForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const location = document.getElementById('location').value.trim();
    const mood = document.getElementById('mood').value.trim();
    
    if (!location || !mood) {
        showError('Please enter both location and mood');
        return;
    }
    
    // Show loading
    document.getElementById('loading').style.display = 'block';
    document.getElementById('errorMessage').style.display = 'none';
    document.getElementById('rouletteContainer').style.display = 'none';
    
    try {
        const response = await fetch('/search', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ location, mood })
        });
        
        const data = await response.json();
        
        // Hide loading
        document.getElementById('loading').style.display = 'none';
        
        if (data.success) {
            displayRoulette(data);
        } else {
            showError(data.error || 'An error occurred while searching for restaurants');
        }
    } catch (error) {
        document.getElementById('loading').style.display = 'none';
        showError('Network error. Please try again.');
    }
});

function showError(message) {
    document.getElementById('errorText').textContent = message;
    document.getElementById('errorMessage').style.display = 'block';
}

function displayRoulette(data) {
    const container = document.getElementById('rouletteContainer');
    
    let html = `
        <div class="success-message">
            <i class="fas fa-check-circle me-2"></i>
            Found ${data.total_restaurants} restaurants in ${data.location} matching "${data.mood}" mood
        </div>
        
        <!-- Roulette Container -->
        <div class="row justify-content-center mb-5">
            <div class="col-lg-8">
                <div class="roulette-container">
                    <div class="roulette-wheel" id="rouletteWheel">
                        <div class="roulette-center">
                            <i class="fas fa-utensils fa-3x"></i>
                        </div>
                        <div class="roulette-sections" id="rouletteSections">
                            <!-- Roulette sections will be generated by JavaScript -->
                        </div>
                    </div>
                    <div class="roulette-controls">
                        <button class="btn btn-success btn-lg" id="spinButton" onclick="spinRoulette()">
                            <i class="fas fa-play me-2"></i>Spin the Roulette!
                        </button>
                        <p class="mt-3 text-muted">Click to spin and discover a random restaurant review!</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Selected Review Display -->
        <div class="row justify-content-center" id="selectedReviewContainer" style="display: none;">
            <div class="col-lg-8">
                <div class="selected-review-card">
                    <h4 class="text-center mb-4">
                        <i class="fas fa-star me-2"></i>Your Selected Review
                    </h4>
                    <div id="selectedReviewContent">
                        <!-- Selected review will be displayed here -->
                    </div>
                    <div class="text-center mt-4">
                        <button class="btn btn-primary" onclick="showRestaurantCard()">
                            <i class="fas fa-utensils me-2"></i>View Full Restaurant
                        </button>
                        <button class="btn btn-outline-secondary ms-2" onclick="spinAgain()">
                            <i class="fas fa-redo me-2"></i>Spin Again
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Restaurant Card Display -->
        <div class="row justify-content-center" id="restaurantCardContainer" style="display: none;">
            <div class="col-lg-10">
                <div id="restaurantCardContent">
                    <!-- Full restaurant card will be displayed here -->
                </div>
            </div>
        </div>
    `;
    
    container.innerHTML = html;
    container.style.display = 'block';
    
    // Initialize roulette with the data
    initializeRoulette(data);
}

// Restaurant data from server
let restaurantData = null;
let selectedRestaurant = null;
let selectedReview = null;
let isSpinning = false;

// Initialize roulette
function initializeRoulette(data) {
    restaurantData = data;
    const sectionsContainer = document.getElementById('rouletteSections');
    const restaurants = data.restaurants;
    
    // Clear previous sections
    sectionsContainer.innerHTML = '';
    
    // Create sections for each restaurant (one review per restaurant)
    restaurants.forEach((restaurant, index) => {
        const section = document.createElement('div');
        section.className = 'roulette-section';
        section.style.transform = `rotate(${index * (360 / restaurants.length)}deg)`;
        section.style.background = getSectionColor(index);
        
        // Add restaurant name to section
        const sectionContent = document.createElement('div');
        sectionContent.className = 'section-content';
        sectionContent.innerHTML = `
            <div class="section-text">${restaurant.name}</div>
            <div class="section-rating">${restaurant.rating}★</div>
        `;
        
        section.appendChild(sectionContent);
        sectionsContainer.appendChild(section);
    });
}

// Get color for each section
function getSectionColor(index) {
    const colors = [
        'linear-gradient(45deg, #ff6b6b, #ee5a24)',
        'linear-gradient(45deg, #4ecdc4, #44a08d)',
        'linear-gradient(45deg, #45b7d1, #96c93d)',
        'linear-gradient(45deg, #f093fb, #f5576c)',
        'linear-gradient(45deg, #4facfe, #00f2fe)',
        'linear-gradient(45deg, #43e97b, #38f9d7)',
        'linear-gradient(45deg, #fa709a, #fee140)',
        'linear-gradient(45deg, #a8edea, #fed6e3)',
        'linear-gradient(45deg, #ff9a9e, #fecfef)',
        'linear-gradient(45deg, #ffecd2, #fcb69f)'
    ];
    return colors[index % colors.length];
}

// Spin the roulette
function spinRoulette() {
    if (isSpinning || !restaurantData) return;
    
    isSpinning = true;
    const spinButton = document.getElementById('spinButton');
    const wheel = document.getElementById('rouletteWheel');
    
    // Disable button
    spinButton.disabled = true;
    spinButton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Spinning...';
    
    // Hide previous results
    document.getElementById('selectedReviewContainer').style.display = 'none';
    document.getElementById('restaurantCardContainer').style.display = 'none';
    
    // Random rotation (5-10 full rotations + random angle)
    const fullRotations = 5 + Math.random() * 5;
    const randomAngle = Math.random() * 360;
    const totalRotation = fullRotations * 360 + randomAngle;
    
    // Apply rotation
    wheel.style.transform = `rotate(${totalRotation}deg)`;
    wheel.style.transition = 'transform 4s cubic-bezier(0.23, 1, 0.32, 1)';
    
    // Calculate which restaurant was selected
    setTimeout(() => {
        const restaurants = restaurantData.restaurants;
        const anglePerRestaurant = 360 / restaurants.length;
        const finalAngle = totalRotation % 360;
        const selectedIndex = Math.floor((360 - finalAngle) / anglePerRestaurant) % restaurants.length;
        
        selectedRestaurant = restaurants[selectedIndex];
        selectedReview = selectedRestaurant.reviews[0]; // Use first review
        
        // Show selected review
        showSelectedReview();
        
        // Re-enable button
        spinButton.disabled = false;
        spinButton.innerHTML = '<i class="fas fa-play me-2"></i>Spin Again!';
        isSpinning = false;
    }, 4000);
}

// Show selected review
function showSelectedReview() {
    const container = document.getElementById('selectedReviewContainer');
    const content = document.getElementById('selectedReviewContent');
    
    const stars = '★'.repeat(selectedReview.rating) + '☆'.repeat(5 - selectedReview.rating);
    
    content.innerHTML = `
        <div class="review-card selected">
            <div class="d-flex justify-content-between align-items-start mb-3">
                <div>
                    <h5 class="mb-1">${selectedRestaurant.name}</h5>
                    <div class="d-flex align-items-center">
                        <span class="rating-stars me-2">${stars}</span>
                        <span class="badge bg-primary me-2">${selectedRestaurant.cuisine}</span>
                        <span class="badge bg-secondary">${selectedRestaurant.price_range}</span>
                    </div>
                </div>
                <span class="review-source">${selectedReview.source}</span>
            </div>
            <div class="review-content">
                <p class="review-text">"${selectedReview.text}"</p>
                <div class="review-meta">
                    <strong>${selectedReview.user_name}</strong>
                    <span class="text-muted ms-2">${selectedReview.time_created}</span>
                </div>
            </div>
        </div>
    `;
    
    container.style.display = 'block';
    container.scrollIntoView({ behavior: 'smooth' });
}

// Show full restaurant card
function showRestaurantCard() {
    const container = document.getElementById('restaurantCardContainer');
    const content = document.getElementById('restaurantCardContent');
    
    const stars = '★'.repeat(Math.floor(selectedRestaurant.rating)) + '☆'.repeat(5 - Math.floor(selectedRestaurant.rating));
    
    content.innerHTML = `
        <div class="restaurant-card">
            <div class="restaurant-header">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h3 class="mb-2">${selectedRestaurant.name}</h3>
                        <div class="d-flex align-items-center mb-2">
                            <span class="rating-stars me-3">${stars}</span>
                            <span class="me-3">${selectedRestaurant.rating}/5</span>
                            <span class="badge bg-light text-dark">${selectedRestaurant.review_count} reviews</span>
                        </div>
                    </div>
                    <div class="col-md-4 text-end">
                        <span class="mood-badge">${restaurantData.mood}</span>
                    </div>
                </div>
            </div>
            
            <div class="restaurant-body">
                <div class="row">
                    <div class="col-md-8">
                        <div class="mb-3">
                            <h5><i class="fas fa-utensils me-2"></i>${selectedRestaurant.cuisine}</h5>
                            <p class="mb-2"><i class="fas fa-map-marker-alt me-2"></i>${selectedRestaurant.address}</p>
                            <p class="mb-2"><i class="fas fa-phone me-2"></i>${selectedRestaurant.phone}</p>
                            <p class="mb-3"><i class="fas fa-dollar-sign me-2"></i>Price Range: ${selectedRestaurant.price_range}</p>
                        </div>
                        
                        <div class="mb-3">
                            <h6><i class="fas fa-tags me-2"></i>Categories:</h6>
                            <div class="d-flex flex-wrap">
                                ${selectedRestaurant.categories.map(cat => `<span class="badge bg-secondary me-2 mb-1">${cat}</span>`).join('')}
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <h6><i class="fas fa-heart me-2"></i>Why it matches your mood:</h6>
                            <p class="text-muted">${selectedRestaurant.mood_match}</p>
                        </div>
                    </div>
                    
                    <div class="col-md-4">
                        <div class="text-center mb-3">
                            <img src="${selectedRestaurant.image_url}" alt="${selectedRestaurant.name}" 
                                 class="img-fluid rounded" style="max-height: 200px; width: 100%; object-fit: cover;">
                        </div>
                        <div class="text-center">
                            <a href="${selectedRestaurant.url}" target="_blank" class="btn btn-outline-primary btn-sm">
                                <i class="fas fa-external-link-alt me-2"></i>View on Yelp
                            </a>
                        </div>
                    </div>
                </div>
                
                <hr>
                
                <div class="reviews-section">
                    <h5><i class="fas fa-comments me-2"></i>All Customer Reviews</h5>
                    ${selectedRestaurant.reviews.map(review => `
                        <div class="review-card">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div>
                                    <strong>${review.user_name}</strong>
                                    <span class="rating-stars ms-2">${'★'.repeat(review.rating)}${'☆'.repeat(5 - review.rating)}</span>
                                </div>
                                <span class="review-source">${review.source}</span>
                            </div>
                            <p class="mb-2">${review.text}</p>
                            <small class="text-muted">${review.time_created}</small>
                        </div>
                    `).join('')}
                </div>
            </div>
        </div>
    `;
    
    container.style.display = 'block';
    container.scrollIntoView({ behavior: 'smooth' });
}

// Spin again
function spinAgain() {
    document.getElementById('selectedReviewContainer').style.display = 'none';
    document.getElementById('restaurantCardContainer').style.display = 'none';
    spinRoulette();
}
</script>

<style>
.roulette-container {
    text-align: center;
    padding: 40px 20px;
}

.roulette-wheel {
    position: relative;
    width: 400px;
    height: 400px;
    margin: 0 auto 30px;
    border-radius: 50%;
    border: 8px solid #fff;
    box-shadow: 0 0 30px rgba(0, 0, 0, 0.3);
    overflow: hidden;
    transition: transform 4s cubic-bezier(0.23, 1, 0.32, 1);
}

.roulette-center {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 80px;
    height: 80px;
    background: linear-gradient(135deg, #667eea, #764ba2);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    z-index: 10;
    box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
}

.roulette-sections {
    position: relative;
    width: 100%;
    height: 100%;
}

.roulette-section {
    position: absolute;
    width: 50%;
    height: 50%;
    top: 0;
    left: 50%;
    transform-origin: 0 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
}

.section-content {
    transform: rotate(45deg);
    text-align: center;
    padding: 10px;
}

.section-text {
    font-size: 0.9em;
    line-height: 1.2;
    margin-bottom: 5px;
}

.section-rating {
    font-size: 0.8em;
    opacity: 0.9;
}

.roulette-controls {
    margin-top: 30px;
}

.selected-review-card {
    background: white;
    border-radius: 15px;
    padding: 30px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    margin-bottom: 30px;
}

.review-card.selected {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    border: none;
    border-radius: 15px;
    padding: 25px;
    box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
}

.review-card.selected .rating-stars {
    color: #ffc107;
}

.review-card.selected .badge {
    background: rgba(255, 255, 255, 0.2) !important;
    color: white !important;
}

.review-card.selected .text-muted {
    color: rgba(255, 255, 255, 0.8) !important;
}

.review-text {
    font-size: 1.1em;
    font-style: italic;
    line-height: 1.6;
    margin-bottom: 15px;
}

.review-meta {
    border-top: 1px solid rgba(255, 255, 255, 0.2);
    padding-top: 15px;
}

@media (max-width: 768px) {
    .roulette-wheel {
        width: 300px;
        height: 300px;
    }
    
    .section-text {
        font-size: 0.8em;
    }
    
    .section-rating {
        font-size: 0.7em;
    }
}
</style>
{% endblock %}
