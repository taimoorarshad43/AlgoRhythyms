{% extends "base.html" %}

{% block title %}Restaurant Roulette - Spin to Find Your Perfect Meal{% endblock %}

{% block content %}
<!-- Header Section -->
<div class="header">
    <div class="logo">
        <i class="fas fa-utensils"></i>
    </div>
    <h1>Restaurant Roulette</h1>
    <p>Spin to find your perfect meal</p>
</div>

<!-- Main Roulette Interface -->
<div class="main-content">
    <!-- Search Form (if no data) -->
    <div id="searchSection">
        <h2 class="section-title">Find Your Perfect Restaurant</h2>
        <p class="section-subtitle">Enter your location and dining mood!</p>
        
            <form id="rouletteSearchForm">
            <div class="form-group">
                <label for="location" class="form-label">
                    <i class="fas fa-map-marker-alt"></i>
                    <i class="fas fa-magic"></i>
                    Where's the action?
                        </label>
                <input type="text" class="form-control" id="location" 
                       placeholder="Enter city, area, or address..." required>
                
                <div class="location-buttons">
                    <button type="button" class="location-btn" data-location="New York City, NY">New York City, NY</button>
                    <button type="button" class="location-btn" data-location="Somerset, NJ">Somerset, NJ</button>
                    <button type="button" class="location-btn" data-location="Los Angeles, CA">Los Angeles, CA</button>
                    <button type="button" class="location-btn" data-location="Chicago, IL">Chicago, IL</button>
                    <button type="button" class="location-btn" data-location="Miami, FL">Miami, FL</button>
                    <button type="button" class="location-btn" data-location="San Francisco, CA">San Francisco, CA</button>
                </div>
            </div>
            
            <div class="form-group">
                <label for="mood" class="form-label">
                    <i class="fas fa-magic"></i>
                    <i class="fas fa-comment"></i>
                    What's your vibe?
                </label>
                
                <div class="mood-options">
                    <button type="button" class="mood-btn" data-mood="spicy and exciting">
                        <div class="mood-title">Spicy & Exciting</div>
                        <div class="mood-description">Hot, bold flavors with energetic atmosphere</div>
                    </button>
                    <button type="button" class="mood-btn" data-mood="romantic and cozy">
                        <div class="mood-title">Romantic & Cozy</div>
                        <div class="mood-description">Intimate settings perfect for dates</div>
                    </button>
                    <button type="button" class="mood-btn" data-mood="casual and fun">
                        <div class="mood-title">Casual & Fun</div>
                        <div class="mood-description">Relaxed atmosphere for friends and family</div>
                    </button>
                    <button type="button" class="mood-btn" data-mood="upscale and elegant">
                        <div class="mood-title">Upscale & Elegant</div>
                        <div class="mood-description">Fine dining with sophisticated ambiance</div>
                    </button>
                </div>
                
                <input type="text" class="form-control mt-3" id="customMood" 
                       placeholder="Or create your own mood...">
            </div>
            
            <button type="submit" class="action-btn">
                <i class="fas fa-search"></i>
                SPIN ROULETTE!
            </button>
            </form>
        </div>
        
        <!-- Loading indicator -->
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <h4>Finding perfect restaurants for your roulette...</h4>
        <p>This may take a moment as we search for the best matches</p>
        </div>
        
        <!-- Error message -->
    <div class="error-message" id="errorMessage">
        <i class="fas fa-exclamation-triangle"></i>
            <span id="errorText"></span>
        </div>
        
    <!-- Roulette Ready Section -->
    <div id="rouletteReadySection" class="d-none">
        <div class="roulette-ready-banner">
            <h2>Roulette Ready!</h2>
            <p>Found <span id="restaurantCount">0</span> restaurants in <span id="searchLocation">Location</span> matching '<span id="searchMood">mood</span>' mood</p>
            <p class="instruction">Tap the wheel to spin!</p>
</div>

        <!-- Roulette Wheel -->
        <div class="roulette-container">
            <div class="roulette-wheel" id="rouletteWheel">
                <div class="roulette-center">
                    <i class="fas fa-utensils"></i>
                </div>
                <div class="roulette-sections" id="rouletteSections">
                    <!-- Roulette sections will be generated by JavaScript -->
                </div>
            </div>
            
            <button class="action-btn" id="spinButton">
                <i class="fas fa-play"></i>
                Spin the Roulette!
            </button>
            <p class="instruction">Click to spin and discover a random restaurant view!</p>
        </div>
        
        <!-- Roulette Table -->
        <div class="roulette-table">
            <h3><i class="fas fa-dice"></i> Roulette Table: <span id="tableCount">0</span> Options</h3>
            <div id="restaurantOptions">
                <!-- Restaurant options will be displayed here -->
                        </div>
                    </div>
                </div>
    
    <!-- Winner Section -->
    <div id="winnerSection" class="d-none">
        <div class="winner-banner">
            <h2>WINNER!</h2>
            <p>Your roulette selection!</p>
        </div>
        
        <div class="selected-restaurant">
            <h4><i class="fas fa-utensils"></i> SELECTED RESTAURANT</h4>
            <div id="selectedRestaurantContent">
                <!-- Selected restaurant details will be displayed here -->
            </div>
        </div>
    </div>
</div>

<!-- Navigation -->
<div class="text-center mt-4">
    <a href="/" class="btn btn-secondary">
        <i class="fas fa-arrow-left"></i>
        New Search
    </a>
</div>
{% endblock %}

{% block scripts %}
<script>
// Global variables
let restaurantData = null;
let selectedRestaurant = null;
let isSpinning = false;
let currentRotation = 0;

// Check for URL parameters on page load
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, checking for URL parameters');
    const urlParams = new URLSearchParams(window.location.search);
    const location = urlParams.get('location');
    const mood = urlParams.get('mood');
    
    console.log('URL params - location:', location, 'mood:', mood);
    
    if (location && mood) {
        console.log('Found URL parameters, pre-filling form and searching');
        // Pre-fill form and search
        document.getElementById('location').value = location;
        document.getElementById('customMood').value = mood;
        searchRestaurants(location, mood);
    } else {
        console.log('No URL parameters found, showing search form');
    }
});

// Location button handlers
document.querySelectorAll('.location-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        document.getElementById('location').value = this.dataset.location;
        document.querySelectorAll('.location-btn').forEach(b => b.style.background = '#E91E63');
        this.style.background = '#C2185B';
    });
});

// Mood button handlers
document.querySelectorAll('.mood-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        document.querySelectorAll('.mood-btn').forEach(b => b.classList.remove('selected'));
        this.classList.add('selected');
        document.getElementById('customMood').value = '';
    });
});

// Custom mood input handler
document.getElementById('customMood').addEventListener('input', function() {
    if (this.value.trim()) {
        document.querySelectorAll('.mood-btn').forEach(b => b.classList.remove('selected'));
    }
});

// Form submission
document.getElementById('rouletteSearchForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const location = document.getElementById('location').value.trim();
    const customMood = document.getElementById('customMood').value.trim();
    const selectedMoodBtn = document.querySelector('.mood-btn.selected');
    const mood = customMood || (selectedMoodBtn ? selectedMoodBtn.dataset.mood : '');
    
    if (!location || !mood) {
        showError('Please enter both location and mood');
        return;
    }
    
    searchRestaurants(location, mood);
});

async function searchRestaurants(location, mood) {
    // Show loading
    document.getElementById('loading').style.display = 'block';
    document.getElementById('errorMessage').style.display = 'none';
    document.getElementById('searchSection').style.display = 'none';
    document.getElementById('rouletteReadySection').style.display = 'none';
    document.getElementById('winnerSection').style.display = 'none';
    
    try {
        const response = await fetch('/search', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ location, mood })
        });
        
        const data = await response.json();
        
        // Hide loading
        document.getElementById('loading').style.display = 'none';
        
        if (data.success) {
            displayRouletteReady(data);
        } else {
            showError(data.error || 'An error occurred while searching for restaurants');
            document.getElementById('searchSection').style.display = 'block';
        }
    } catch (error) {
        document.getElementById('loading').style.display = 'none';
        showError('Network error. Please try again.');
        document.getElementById('searchSection').style.display = 'block';
    }
}

function showError(message) {
    document.getElementById('errorText').textContent = message;
    document.getElementById('errorMessage').style.display = 'block';
}

function displayRouletteReady(data) {
    restaurantData = data;
    
    // Update banner text
    document.getElementById('restaurantCount').textContent = data.total_restaurants;
    document.getElementById('searchLocation').textContent = data.location;
    document.getElementById('searchMood').textContent = data.mood;
    document.getElementById('tableCount').textContent = data.total_restaurants;
    
    // Create roulette sections
    createRouletteSections(data.restaurants);
    
    // Create restaurant options
    createRestaurantOptions(data.restaurants);
    
    // Show roulette ready section
    document.getElementById('rouletteReadySection').classList.remove('d-none');
}

function createRouletteSections(restaurants) {
    console.log('createRouletteSections called with:', restaurants);
    const sectionsContainer = document.getElementById('rouletteSections');
    console.log('Sections container:', sectionsContainer);
    
    if (!sectionsContainer) {
        console.error('Roulette sections container not found!');
        return;
    }
    
    sectionsContainer.innerHTML = '';
    
    restaurants.forEach((restaurant, index) => {
        const section = document.createElement('div');
        section.className = 'roulette-section';
        section.style.transform = `rotate(${index * (360 / restaurants.length)}deg)`;
        section.style.background = getSectionColor(index);
        
        const sectionContent = document.createElement('div');
        sectionContent.className = 'section-content';
        sectionContent.innerHTML = `
            <div class="section-text">${restaurant.name}</div>
            <div class="section-rating">${restaurant.rating}★</div>
        `;
        
        section.appendChild(sectionContent);
        sectionsContainer.appendChild(section);
        console.log(`Created section for ${restaurant.name}`);
    });
    
    console.log(`Created ${restaurants.length} roulette sections`);
}

function createRestaurantOptions(restaurants) {
    console.log('createRestaurantOptions called with:', restaurants);
    const optionsContainer = document.getElementById('restaurantOptions');
    console.log('Options container:', optionsContainer);
    
    if (!optionsContainer) {
        console.error('Restaurant options container not found!');
        return;
    }
    
    optionsContainer.innerHTML = '';
    
    restaurants.forEach((restaurant, index) => {
        const option = document.createElement('div');
        option.className = 'restaurant-option';
        option.innerHTML = `
            <div class="option-number">${index}</div>
            <div class="option-details">
                <div class="option-name">${restaurant.name}</div>
                <div class="option-cuisine">${restaurant.cuisine} • ${restaurant.price_range}</div>
            </div>
        `;
        optionsContainer.appendChild(option);
        console.log(`Created option for ${restaurant.name}`);
    });
    
    console.log(`Created ${restaurants.length} restaurant options`);
}

function getSectionColor(index) {
    const colors = [
        'linear-gradient(45deg, #ff6b6b, #ee5a24)',
        'linear-gradient(45deg, #4ecdc4, #44a08d)',
        'linear-gradient(45deg, #45b7d1, #96c93d)',
        'linear-gradient(45deg, #f093fb, #f5576c)',
        'linear-gradient(45deg, #4facfe, #00f2fe)',
        'linear-gradient(45deg, #43e97b, #38f9d7)',
        'linear-gradient(45deg, #fa709a, #fee140)',
        'linear-gradient(45deg, #a8edea, #fed6e3)',
        'linear-gradient(45deg, #ff9a9e, #fecfef)',
        'linear-gradient(45deg, #ffecd2, #fcb69f)'
    ];
    return colors[index % colors.length];
}

// Spin button handler
document.getElementById('spinButton').addEventListener('click', function() {
    if (isSpinning) return;
    
    // Check if we have restaurant data
    if (!restaurantData || !restaurantData.restaurants || restaurantData.restaurants.length === 0) {
        console.error('No restaurant data available for spinning');
        alert('No restaurants available. Please search for restaurants first.');
        return;
    }
    
    isSpinning = true;
    const spinButton = this;
    const wheel = document.getElementById('rouletteWheel');
    
    // Disable button
    spinButton.disabled = true;
    spinButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Spinning...';
    
    // Hide winner section
    document.getElementById('winnerSection').classList.add('d-none');
    
    // Random rotation (5-10 full rotations + random angle)
    const fullRotations = 5 + Math.random() * 5;
    const randomAngle = Math.random() * 360;
    const totalRotation = currentRotation + (fullRotations * 360) + randomAngle;
    currentRotation = totalRotation;
    
    // Apply rotation
    wheel.style.transform = `rotate(${totalRotation}deg)`;
    wheel.style.transition = 'transform 4s cubic-bezier(0.23, 1, 0.32, 1)';
    
    // Calculate which restaurant was selected
    setTimeout(() => {
        const restaurants = restaurantData.restaurants;
        const anglePerRestaurant = 360 / restaurants.length;
        const finalAngle = totalRotation % 360;
        const selectedIndex = Math.floor((360 - finalAngle) / anglePerRestaurant) % restaurants.length;
        
        selectedRestaurant = restaurants[selectedIndex];
        
        console.log('Selected restaurant:', selectedRestaurant);
        console.log('Selected index:', selectedIndex);
        console.log('Total rotation:', totalRotation);
        console.log('Final angle:', finalAngle);
        console.log('Angle per restaurant:', anglePerRestaurant);
        
        // Show winner
        showWinner();
        
        // Re-enable button
        spinButton.disabled = false;
        spinButton.innerHTML = '<i class="fas fa-play"></i> Spin Again!';
        isSpinning = false;
    }, 4000);
});

function showWinner() {
    console.log('showWinner called with:', selectedRestaurant);
    
    // Update restaurant options to highlight winner
    const options = document.querySelectorAll('.restaurant-option');
    console.log('Found options:', options.length);
    
    options.forEach((option, index) => {
        option.classList.remove('winner');
        const optionName = option.querySelector('.option-name');
        if (optionName && selectedRestaurant.name === optionName.textContent) {
            option.classList.add('winner');
            console.log('Highlighted winner option:', optionName.textContent);
        }
    });
    
    // Show winner section
    const winnerSection = document.getElementById('winnerSection');
    console.log('Winner section element:', winnerSection);
    console.log('Winner section classes before:', winnerSection.className);
    winnerSection.classList.remove('d-none');
    console.log('Winner section classes after:', winnerSection.className);
    console.log('Winner section display style:', window.getComputedStyle(winnerSection).display);
    
    // Display selected restaurant details
    displaySelectedRestaurant();
}

function displaySelectedRestaurant() {
    console.log('displaySelectedRestaurant called with:', selectedRestaurant);
    const content = document.getElementById('selectedRestaurantContent');
    console.log('Content element:', content);
    
    if (!selectedRestaurant) {
        console.error('No selected restaurant to display');
        return;
    }
    
    const stars = '★'.repeat(Math.floor(selectedRestaurant.rating)) + '☆'.repeat(5 - Math.floor(selectedRestaurant.rating));
    
    content.innerHTML = `
        <div class="restaurant-card">
            <div class="restaurant-header">
                <div class="restaurant-name">${selectedRestaurant.name}</div>
                <div class="price-badge">${selectedRestaurant.price_range}</div>
            </div>
            
            <div class="rating">
                <div class="stars">${stars}</div>
                <div class="rating-text">${selectedRestaurant.rating} (${selectedRestaurant.review_count})</div>
                        </div>
                        
            <div class="restaurant-details">
                <div class="detail-item">
                    <i class="fas fa-map-marker-alt"></i>
                    <span>${selectedRestaurant.address}</span>
                </div>
                <div class="detail-item">
                    <i class="fas fa-phone"></i>
                    <span>${selectedRestaurant.phone}</span>
                </div>
                <div class="detail-item">
                    <i class="fas fa-utensils"></i>
                    <span>Cuisine: <span style="color: #FF9800;">${selectedRestaurant.cuisine}</span></span>
                            </div>
                <div class="detail-item">
                    <i class="fas fa-heart"></i>
                    <span>Mood: <span style="color: #2196F3;">${restaurantData.mood}</span></span>
                        </div>
                <div class="detail-item">
                    <i class="fas fa-star"></i>
                    <span>Vibe: <span style="color: #4CAF50;">Upscale</span></span>
                        </div>
                    </div>
                    
            <div class="restaurant-description">
                <p>${selectedRestaurant.mood_match}</p>
                </div>
                
                <div class="reviews-section">
                <h5><i class="fas fa-star"></i> Reviews</h5>
                        <div class="review-card">
                    <div class="review-header">
                        <div class="review-source">Google</div>
                        <div class="review-date">2024-01-08</div>
                                </div>
                    <div class="review-text">"${selectedRestaurant.reviews[0].text}"</div>
                    <div class="review-author">— ${selectedRestaurant.reviews[0].user_name}</div>
                </div>
            </div>
            
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="viewFullDetails()">
                    <i class="fas fa-eye"></i>
                    SEE FULL DETAILS
                </button>
                <button class="btn btn-secondary" onclick="spinAgain()">
                    <i class="fas fa-redo"></i>
                    SPIN AGAIN
                </button>
                <button class="btn btn-info">
                    <i class="fas fa-map-marker-alt"></i>
                    DIRECTIONS
                </button>
                <button class="btn btn-info">
                    <i class="fas fa-phone"></i>
                    CALL
                </button>
            </div>
        </div>
    `;
}

function viewFullDetails() {
    if (selectedRestaurant) {
        // Map restaurant names to demo IDs for the details page
        const restaurantIdMap = {
            'Jalapeno And Cilantro Grill': 'demo_1',
            'Ara\'s Hot Chicken': 'demo_2',
            '蜀世冒菜 S&Y Mini HotPot': 'demo_3'
        };
        
        const restaurantId = restaurantIdMap[selectedRestaurant.name] || 'demo_1';
        const mood = restaurantData ? restaurantData.mood : 'upscale and elegant';
        
        window.location.href = `/restaurant/${restaurantId}?mood=${encodeURIComponent(mood)}`;
    }
}

function spinAgain() {
    document.getElementById('winnerSection').classList.add('d-none');
    document.getElementById('spinButton').click();
}
</script>

<style>
/* Roulette Ready Banner */
.roulette-ready-banner {
    background: #2D2D2D;
    border: 2px solid #4CAF50;
    border-radius: 15px;
    padding: 30px;
    text-align: center;
    margin-bottom: 30px;
}

.roulette-ready-banner h2 {
    color: white;
    font-size: 2rem;
    margin-bottom: 10px;
}

.roulette-ready-banner p {
    color: #B0B0B0;
    margin-bottom: 5px;
}

.roulette-ready-banner .instruction {
    color: #4CAF50;
    font-weight: 600;
}

/* Roulette Table */
.roulette-table {
    background: #2D2D2D;
    border: 2px solid #4CAF50;
    border-radius: 15px;
    padding: 30px;
    margin-top: 30px;
}

.roulette-table h3 {
    color: white;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
}

.roulette-table h3 i {
    color: #E91E63;
    margin-right: 10px;
}

.restaurant-option {
    background: #1A1A1A;
    border-radius: 10px;
    padding: 15px;
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    transition: all 0.3s ease;
}

.restaurant-option.winner {
    background: #FFD700;
    color: #1A1A1A;
    font-weight: 600;
}

.option-number {
    background: #4CAF50;
    color: white;
    width: 30px;
    height: 30px;
    border-radius: 5px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    margin-right: 15px;
}

.restaurant-option.winner .option-number {
    background: #E91E63;
}

.option-details {
    flex: 1;
}

.option-name {
    font-weight: 600;
    margin-bottom: 5px;
}

.option-cuisine {
    color: #B0B0B0;
    font-size: 0.9rem;
}

/* Winner Section */
.winner-banner {
    background: linear-gradient(135deg, #FFD700, #FFA000);
    color: #1A1A1A;
    text-align: center;
    padding: 30px;
    border-radius: 15px;
    margin-bottom: 30px;
}

.winner-banner h2 {
    font-size: 3rem;
    font-weight: 800;
    margin-bottom: 10px;
}

.winner-banner p {
    font-size: 1.2rem;
    font-weight: 600;
}

.selected-restaurant {
    background: #2D2D2D;
    border-radius: 15px;
    padding: 30px;
    margin-bottom: 30px;
}

.selected-restaurant h4 {
    color: #B0B0B0;
    font-size: 0.9rem;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
}

.selected-restaurant h4 i {
    color: #E91E63;
    margin-right: 10px;
}

.restaurant-description {
    background: #1A1A1A;
    border-radius: 10px;
    padding: 20px;
    margin: 20px 0;
    font-style: italic;
    color: #B0B0B0;
}

.reviews-section h5 {
    color: #FFD700;
    margin-bottom: 15px;
    display: flex;
    align-items: center;
}

.reviews-section h5 i {
    margin-right: 10px;
}

.review-date {
    color: #B0B0B0;
    font-size: 0.9rem;
}

/* Responsive Design */
@media (max-width: 768px) {
    .roulette-wheel {
        width: 300px;
        height: 300px;
    }
    
    .section-text {
        font-size: 0.8em;
    }
    
    .section-rating {
        font-size: 0.7em;
    }
    
    .action-buttons {
        flex-direction: column;
    }
    
    .winner-banner h2 {
        font-size: 2rem;
    }
}
</style>
{% endblock %}
